<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  
<!-- Mirrored from www.catch22.net/tuts/win32/system-image-list by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 27 Apr 2022 20:48:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>System Image List - Catch22</title>
<meta name="description" content="Chinese translation atwww.titilima.cn">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Catch22">
<meta property="og:title" content="System Image List">
<meta property="og:url" content="system-image-list.html">


  <meta property="og:description" content="Chinese translation atwww.titilima.cn">







  <meta property="article:published_time" content="2002-07-02T00:00:00+00:00">






<link rel="canonical" href="system-image-list.html">













<!-- end _includes/seo.html -->


<link href="http://www.catch22.net/feed.xml" type="application/atom+xml" rel="alternate" title="Catch22 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://www.catch22.net/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--tutorial wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="http://www.catch22.net/">Catch22</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="http://www.catch22.net/blog/" >Blog</a>
            </li><li class="masthead__menu-item">
              <a href="http://www.catch22.net/software/" >Software</a>
            </li><li class="masthead__menu-item">
              <a href="../index.html" >Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="http://www.catch22.net/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://www.catch22.net/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://www.catch22.net/tuts" itemprop="item"><span itemprop="name">Tuts</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
                
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="../win32.html" itemprop="item"><span itemprop="name">Win32</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
                
      
    
      
      
        <li class="current">System Image List</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
    
      
  <div class="file-attachments">
    <h4>DOWNLOADS</h4>
    
      
       <a href="http://www.catch22.net/assets/files/tuts/win32/sysimg.zip">sysimg.zip</a>      
    
  </div>

    
    

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="System Image List">
    <meta itemprop="description" content="Chinese translation atwww.titilima.cn">
    <meta itemprop="datePublished" content="July 02, 2002">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">System Image List
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <!--h1>System Image List</h1-->
<!--h3>How to access the System Image List (AKA the Shell Icon Cache)</h3-->

<p><a href="http://www.titilima.cn/readarticle.php?id=79">Chinese translation at</a><a href="http://www.titilima.cn/">www.titilima.cn</a></p>

<h2 id="introduction">Introduction</h2>

<p>The System Image List (or Shell Icon Cache as it is sometimes called) is an icon resource maintained by the Windows Shell. This list is used by Explorer, among other applications, to display the icons for system objects, programs and document types.</p>

<p><img src="http://www.catch22.net/assets/img/sysimg01.gif" alt="{short description of image}" class="align-center" /></p>

<p>The list is no more than a simple <code class="highlighter-rouge">HIMAGELIST</code> (a standard Imagelist, which can be accessed using the standard image list API). Some applications may find it useful to display system supplied icons, rather than storing their own duplicate icons internally. So, the aim of this tutorial is to demonstrate how to access the System Image List and use it within your own applications.</p>

<h2 id="simple-method-first">Simple method first</h2>

<p>If you’ve ever spent any time browsing around the MSDN help system, you may have stumbled over the <code class="highlighter-rouge">SHGetFileInfo</code> API call (exported from shell32.dll, available in Win9x and WinNT4/2000/XP). The function looks like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD_PTR</span> <span class="n">SHGetFileInfo</span><span class="p">(</span>
    <span class="n">LPCTSTR</span> <span class="n">pszPath</span><span class="p">,</span>              
    <span class="n">DWORD</span> <span class="n">dwFileAttributes</span><span class="p">,</span>
    <span class="n">SHFILEINFO</span> <span class="o">*</span><span class="n">psfi</span><span class="p">,</span>
    <span class="n">UINT</span> <span class="n">cbFileInfo</span><span class="p">,</span>
    <span class="n">UINT</span> <span class="n">uFlags</span>
<span class="p">);</span>
</code></pre></div></div>

<p>This function call can be used to get information for a specified file. The <code class="highlighter-rouge">uFlags</code> parameter specified what information is desired. Two particularly interesting values for this parameter are <code class="highlighter-rouge">SHGFI_ICON</code> and <code class="highlighter-rouge">SHGFI_SYSICONINDEX</code>. When these flags are specified, <code class="highlighter-rouge">SHGetFileInfo</code> returns a handle to the system imagelist, and stores the index of the requested icon type in the <code class="highlighter-rouge">SHFILEINFO</code> structure.</p>

<p>The following call demonstrates how this is possible:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SHFILEINFO</span> <span class="n">shfi</span><span class="p">;</span>
<span class="n">HIMAGELIST</span> <span class="n">hSysImgList</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">hSysImgList</span> <span class="o">=</span> <span class="p">(</span><span class="n">HIMAGELIST</span><span class="p">)</span><span class="n">SHGetFileInfo</span><span class="p">(</span>
       <span class="s">"C:</span><span class="se">\"</span><span class="s">, </span><span class="err">
</span><span class="s">       0, </span><span class="err">
</span><span class="s">       &amp;shfi, </span><span class="err">
</span><span class="s">       sizeof(SHFILEINFO), </span><span class="err">
</span><span class="s">       SHGFI_SYSICONINDEX | SHGFI_SMALLICON | SHGFI_ICON);</span><span class="err">
</span></code></pre></div></div>

<h2 id="platform-differences">Platform differences</h2>

<p>There is a subtle, but important difference between Windows 9x and Windows NT family of operating systems. Under Windows 9x, <code class="highlighter-rouge">SHGetFileInfo</code> returns <strong>the</strong> handle to the system imagelist, which is shared by all processes. This imagelist is the same one used by Explorer and the Shell to display the system icons. That means that if one process corrupts the imagelist in any way, all processes (this includes Explorer) will be affected.</p>

<p>Under Windows NT (and 2000/XP) things are slightly different. Due to the system architecture, and also to maintain a robust operating environment, <code class="highlighter-rouge">SHGetFileInfo</code> will return a <em>separate copy</em> of the system imagelist to each process that requests it (one for each process). What’s more, <code class="highlighter-rouge">SHGetFileInfo</code> does not return the whole system imagelist like it does with Windows 9x - only those icons requested in the call to <code class="highlighter-rouge">SHGetFileInfo</code> will be present in the imagelist - all the other entries are left blank. For 99% of situations this does not matter, but because we want to make a viewer application to view the whole imagelist, this presents us with a problem.</p>

<h2 id="locating-the-system-imagelist-on-all-versions-of-windows">Locating the System Imagelist on all versions of Windows</h2>

<p>I’m not going to beat around the bush. There is an undocumented API call inside Shell32.DLL called <code class="highlighter-rouge">Shell_GetImageLists</code>, which - you guessed it - returns a handle to the system imagelists (note the plural here - there are large and small icon versions). This undocumented API call is available on all versions of Windows that ship with shell32.dll.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">Shell_GetImageLists</span><span class="p">(</span><span class="n">HIMAGELIST</span> <span class="o">*</span><span class="n">lphimlLarge</span><span class="p">,</span> <span class="n">HIMAGELIST</span> <span class="o">*</span><span class="n">lphimlSmall</span><span class="p">);</span>
</code></pre></div></div>

<p>The one other API we need is <code class="highlighter-rouge">FileIconInit</code>, which is only available under Window NT/2000/XP. This is not a problem, because we only need to call is under Windows NT anyway.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">FileIconInit</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">bFullInit</span><span class="p">);</span>
</code></pre></div></div>

<p>These APIs are not exported by name, only by ordinal:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">;</span> <span class="n">Shell32</span> <span class="n">undocumented</span> <span class="n">functions</span>
<span class="n">Shell_GetImageLists</span> <span class="err">@</span><span class="mi">71</span>
<span class="n">FileIconInit</span> <span class="err">@</span><span class="mi">660</span>
</code></pre></div></div>

<p>Armed with this information, we can now write a function to return the handles to the system imagelist. The first step is to make a couple of <code class="highlighter-rouge">typedef</code>’s to make our lives easier.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">SH_GIL_PROC</span><span class="p">)(</span><span class="n">HIMAGELIST</span> <span class="o">*</span><span class="n">phLarge</span><span class="p">,</span> <span class="n">HIMAGELIST</span> <span class="o">*</span><span class="n">phSmall</span><span class="p">);</span>
<span class="k">typedef</span> <span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">FII_PROC</span><span class="p">)</span> <span class="p">(</span><span class="n">BOOL</span> <span class="n">fFullInit</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">SH_GIL_PROC</code> is short for <code class="highlighter-rouge">Shell_GetIconLists_Procecedure</code>, <code class="highlighter-rouge">FII_PROC</code> is short for <code class="highlighter-rouge">FileIconInit_Procedure</code>. Now we can locate the undocumented functions from inside Shell32.DLL so that we can call them:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HMODULE</span> <span class="n">hShell32</span><span class="p">;</span>
<span class="n">SH_GIL_PROC</span> <span class="n">Shell_GetImageLists</span><span class="p">;</span>
<span class="n">FII_PROC</span> <span class="n">FileIconInit</span><span class="p">;</span>	

<span class="c1">// Load SHELL32.DLL, if it isn't already
</span><span class="n">hShell32</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"shell32.dll"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">hShell32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="c1">//
// Get Undocumented APIs from Shell32.dll:
//
</span><span class="n">Shell_GetImageLists</span> <span class="o">=</span> <span class="p">(</span><span class="n">SH_GIL_PROC</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="mi">71</span><span class="p">);</span>
<span class="n">FileIconInit</span> <span class="o">=</span> <span class="p">(</span><span class="n">FII_PROC</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="mi">660</span><span class="p">);</span>
</code></pre></div></div>

<p>Note how the ordinals are simply passed as parameters to <code class="highlighter-rouge">GetProcAddress</code>. OK, now we have pointers to the functions we need we can proceed:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Initialize imagelist for this process - function not present on win95/98
</span><span class="k">if</span><span class="p">(</span><span class="n">FileIconInit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">FileIconInit</span><span class="p">(</span><span class="n">TRUE</span><span class="p">);</span>

<span class="c1">// Get handles to the large+small system image lists!
</span><span class="n">Shell_GetImageLists</span><span class="p">(</span><span class="n">phLarge</span><span class="p">,</span> <span class="n">phSmall</span><span class="p">);</span>

<span class="c1">// Do NOT free shell32.dll!
</span></code></pre></div></div>

<p>The last comment in the snippet above says “Do NOT free shell32.dll”. This is important, because as soon as shell32.dll is unloaded, the system-image lists are destroyed, undoing all our hard work.</p>

<p>So, that’s it! We now have handles to the large and small system imagelists, which we can display using the sample viewer application provided (see the link at the top of the page).</p>

<h2 id="never-modify-or-delete-the-system-image-list">Never modify or delete the System Image List!</h2>

<p>There is one more important piece of information that you should know before we go any further. You should never try to add icons to, remove icons from, or delete the System Imagelist. This is explained clearly in the documentation for <code class="highlighter-rouge">SHGetFileInfo</code>, and very good advise this is, too. However, there is one very easy way to accidently delete the System Imagelist.</p>

<p>One very common practise is for an application to create a TreeView or ListView, to display the names and details of files in the system (like Explorer, or WinZip for example). In order to display the system icons next to each entry in a TreeView / ListView, an application typically uses, for example, the <code class="highlighter-rouge">LVM_SETIMAGELIST</code> message (or the <code class="highlighter-rouge">ListView_SetImageList</code> macro) to assign an imagelist to the control. So, it would be entirely feasible for a program to obtain a handle to the system imagelist, and assign it to a control to use as it’s own icon list. In fact, this is very probably how Explorer works.</p>

<p>Now for the problem. By default, when a ListView control is destroyed, it will automatically delete it’s associated image list using the <code class="highlighter-rouge">ImageList_Destroy</code> API call. That’s right, by default your program will obliterate the system imagelist without you even asking it to! Fortunately, there is a ListView control style (<code class="highlighter-rouge">LVS_SHAREIMAGELISTS</code>) which prevents a ListView control from deleting it’s imagelist. (Make sure you set this style if you are in this situation!).</p>

<p>Mysteriously, the TreeView control does not suffer this problem - MSDN states that a TreeView will not destroy it’s associated imagelist, so only the ListView control needs special attention.</p>

<p>Obviously, if your program runs under Windows NT/2000/XP, accidently deleting the system imagelist is not very serious, because you are only deleting your own process’s copy of the imagelist. However, under Windows 95/98/ME, deleting the imagelist will have disasterous consequences. Well, just try it and see!</p>

<h2 id="conclusion">Conclusion</h2>

<p>Obtaining the complete system imagelist could have been tricky, especially if we had had to resort to hacking the icons directly from the cached disk file they are stored in. Fortunately, there are a couple of undocumented API calls which came to the rescue. Of course, I can’t claim credit for discovering these - I found this information on <a href="http://www.geocities.com/SiliconValley/4942/index.html">James Holderness’s excellent website</a>, which has more information on the sytem imagelist than I presented here, as well as loads more undocumented goodies! Check it out now!</p>

<p>Have fun!</p>



  <div class="file-attachments">
    <h4>DOWNLOADS</h4>
    
      
       <a href="http://www.catch22.net/assets/files/tuts/win32/sysimg.zip">sysimg.zip</a>      
    
  </div>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2002-07-02T00:00:00+00:00">July 02, 2002</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="docking-toolbars-part-2.html" class="pagination--pager" title="Docking Toolbars - Part 2
">Previous</a>
    
    
      <a href="custom-combobox.html" class="pagination--pager" title="Custom Combobox
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="http://www.catch22.net/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Catch22. Powered by <a href="https://jekyllrb.com/" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://www.catch22.net/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script>








  </body>

<!-- Mirrored from www.catch22.net/tuts/win32/system-image-list by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 27 Apr 2022 20:48:44 GMT -->
</html>
